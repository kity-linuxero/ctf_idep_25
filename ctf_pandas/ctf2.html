<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>Panchita la Pandita ‚Äî PandaIDORgame</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<style>
  body{
    font-family:system-ui,Segoe UI,Roboto,Arial;
    color:#fff;
    background: #111 url('https://images.unsplash.com/photo-1527118732049-c88155f2107c?q=80&w=1000&auto=format&fit=crop') no-repeat center center fixed;
    background-size: cover;
    min-height:100vh;
  }
  .panel{
    background: rgba(0, 0, 0, 0.7);
    border: 1px solid #444;
  }
  #log{
    font-size:12px;
    color:#111;
    background:#f1f1f1;
    border-radius:10px;
    padding:8px;
    margin-top:6px;
    max-height:160px;
    overflow:auto;
  }
  .log-success{background:#e8ffe8; color:#083; padding:6px 8px; border-radius:8px; margin-bottom:6px; font-weight:700}
  .log-info{background:#fff7d6; color:#6a4a00; padding:6px 8px; border-radius:8px; margin-bottom:6px}
</style>
</head>
<body>

  <div class="position-fixed top-0 start-0 p-3 z-3">
    <button class="btn btn-success" id="btnEnunciado">‚Ñπ Enunciado</button>
    <button class="btn btn-secondary" id="btnReset">‚Ü∫ Reiniciar</button>
  </div>

  <main class="container py-5">
    <div class="col-md-6 offset-md-3">
      <div class="panel p-3 rounded mb-4">
        <h3>Panchita la pandita</h3>
        <div><strong>Usuario actual:</strong> <span id="userName">Panchita la pandita</span></div>
        <div><strong>Mis recursos:</strong> <span id="myBamboo">100</span> üéã</div>
      </div>

      <div id="formContainer">
          <div class="panel p-3 rounded mb-4">
              <h4>Enviar Bamboo</h4>
              <form id="transferForm" onsubmit="return false;">
                  <input type="hidden" name="from_id" value="0">
                  <div class="vstack gap-2">
                      <label class="form-label" for="friendSelect">Enviar a:</label>
                      <select id="friendSelect" name="to_id" class="form-select">
                        <option value="1">CocoPandita</option>
                        <option value="2">LuliPandita</option>
                        <option value="3">MaxiPandita</option>
                      </select>
                      <label class="form-label" for="amount">Cantidad de Bamboo:</label>
                      <input id="amount" name="amount" type="number" class="form-control" placeholder="M√°ximo 5 bamboo" />
                      <button class="btn btn-success" id="btnSend">Enviar</button>
                      <div id="log" aria-live="polite" hidden></div>
                  </div>
              </form>
          </div>
      </div>

      <div class="panel p-3 rounded mb-4">
        <h4>Recursos de otras Pandaldeas</h4>
        <ul id="friendsList" class="list-unstyled">
          <li>CocoPandita tiene <span id="f1">70</span> üéã</li>
          <li>LuliPandita tiene <span id="f2">60</span> üéã</li>
          <li>MaxiPandita tiene <span id="f3">50</span> üéã</li>
        </ul>
      </div>

              <div class="panel p-3 rounded">
                <button class="btn btn-light" id="openFormEditorBtn" data-bs-toggle="modal" data-bs-target="#formEditorOverlay">üìù Abrir editor </button>
              </div>    </div>
  </main>

  <!-- Modal Enunciado -->
  <div class="modal fade" id="modalEnunciado" tabindex="-1" aria-labelledby="modalEnunciadoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title" id="modalEnunciadoLabel">Enunciado del Desaf√≠o üêº</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          
        </div>
        
        <div class="modal-body text-dark">
          <p>En este juego, tu personaje es <strong>Panchita la pandita</strong>, quien quiere mejorar su Pandaldea pero necesita <strong>280 de bamb√∫</strong> para lograrlo. Lamentablemente, le resulta muy dif√≠cil juntar esa cantidad.</p>
          <p>Solo se permite el env√≠o de bamboo de unas Pandaldeas a otras Pandaldeas. </p>
          <p>S√≥lo podras enviar 5 bamboo a cada Pandaldea y solo hacer un env√≠o a cada una. </p>
          <!-- <p>Puedes enviar bamboo las veces que quieras a distintas Pandaldeas.</p> -->
          <p><strong>OBJETIVO:</strong> Ayudar a Panchita la pandita a obtener los 280 de bamboo necesarios explotando vulnerabilidades en el sistema de transferencias entre Pandaldeas..</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Editor -->
  <div class="modal fade" id="formEditorOverlay" tabindex="-1" aria-labelledby="formEditorLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title" id="formEditorLabel">Editor de Formulario HTML</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <textarea id="formCodeArea" class="form-control" style="height: 50vh" spellcheck="false"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-success" id="applyHtmlChanges">Aplicar Cambios</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Misi√≥n Cumplida -->
  <div class="modal fade" id="flagModal" tabindex="-1" aria-labelledby="flagModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title" id="flagModalLabel">üéâ ¬°Misi√≥n Cumplida! üéâ</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-dark text-center">
          <p>Lograste conseguir todo el bamb√∫ para Panchita. Pero al hacerlo, interceptaste una extra√±a secuencia de datos:</p>
          <p><strong>Parece tener alg√∫n tipo de significado. Si descubres ese ser√° tu flag üö©</strong></p>
          <strong id="flag" style="font-family: monospace; font-size: 1.1em;"></strong>
          <button class="btn btn-sm btn-outline-success mt-2" id="copyFlagBtn">Copiar Flag</button>
          <p class="mt-3 mb-0 text-muted" style="font-size: 0.8em;">Basado en CTF de Ekoparty 2025 de BugBountyGirlsClub.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
/* ---------- Estado e inicializaci√≥n ---------- */
let players, receivedOnce;
const logDiv = document.getElementById('log');

function resetGame(){
  players = {
//    0:{name:"Panchita la pandita", bamboo:100},
    1:{name:"CocoPandita",       bamboo:70},
    2:{name:"LuliPandita",       bamboo:60},
    3:{name:"MaxiPandita",       bamboo:50},
  };
  receivedOnce = {}; 
  docRefresh();
  clearLog();
  document.getElementById('formContainer').innerHTML = initialFormHtml;
  document.getElementById('btnSend').addEventListener('click', handleSend);
}

function docRefresh(){
  document.getElementById('myBamboo').textContent = players[0].bamboo;
  document.getElementById('f1').textContent = players[1].bamboo;
  document.getElementById('f2').textContent = players[2].bamboo;
  document.getElementById('f3').textContent = players[3].bamboo;
}
function clearLog(){ logDiv.innerHTML = ''; }

/* ---------- Funci√≥n "backend" (simulada) ---------- */
function apiTransfer(payload) {
    const { from_id, to_id, amount } = payload;
    const from = players[from_id];
    const to = players[to_id];
    if (!from || !to) {
        appendLogInfo(`‚ùå Error: IDs inv√°lidos.`);
        return false;
    }
    if (!Number.isFinite(amount) || amount <= 0) {
        appendLogInfo(`‚ùå Error: Monto inv√°lido.`);
        return false;
    }
    if (from.bamboo < amount) {
        appendLogInfo(`‚ùå Error: ${from.name} no tiene suficiente bamboo.`);
        return false;
    }
    from.bamboo -= amount;
    to.bamboo   += amount;
    docRefresh();
    checkWin();
    return true;
}


function checkWin(){
  if(players[0].bamboo === 280){
    
    // Make a request to the backend to get the flag
    fetch('/verificar', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ bamboo: 280 })
    })
    .then(response => response.json())
    .then(data => {
      if(data.flag) {
        document.getElementById('flag').textContent = data.flag;
        flagModal.show(); // Show the new flag modal
      } else {
        console.error('Error fetching flag:', data.error);
        appendLogInfo(`‚ùå Error del servidor: ${data.error}`);
      }
    })
    .catch(error => {
      console.error('Fetch error:', error);
      appendLogInfo(`‚ùå Error de red al contactar el servidor.`);
    });
  }
}

/* ---------- Helpers de UI para log ---------- */
function prependNode(node){ logDiv.prepend(node); }
function appendLogSuccess(text){
  const d = document.createElement('div'); d.className='log-success'; d.textContent = text; prependNode(d);
}
function appendLogInfo(text){
  const d = document.createElement('div'); d.className='log-info'; d.textContent = text; prependNode(d);
}

/* ---------- L√≥gica de Env√≠o desde el Formulario (CON RESTRICCIONES) ---------- */
function handleSend() {
    const form = document.getElementById('transferForm');
    const from_id = parseInt(form.querySelector('input[name="from_id"]').value, 10);
    const to_id = parseInt(form.querySelector('select[name="to_id"]').value, 10);
    const amount = parseInt(form.querySelector('input[name="amount"]').value, 10);

    if (isNaN(from_id) || isNaN(to_id) || isNaN(amount)) {
        return alert("Datos del formulario inv√°lidos. Revisa el c√≥digo en el editor.");
    }
    
    if (from_id === 0) {
        if (amount > 5) {
            return alert("Error: Desde la interfaz solo puedes enviar un m√°ximo de 5 de bamb√∫.");
        }
        if (receivedOnce[to_id]) {
            return alert("Error: Ya has enviado bamb√∫ a este panda. Solo puedes hacerlo una vez.");
        }
        
        const success = apiTransfer({ from_id, to_id, amount });
        
        if (success) {
            receivedOnce[to_id] = true;
            const destName = players[to_id] ? players[to_id].name : "un panda desconocido";
            appendLogSuccess(`‚úÖ Enviaste ${amount} de bamb√∫ a ${destName}.`);
        }
        return;
    }
    
    apiTransfer({ from_id, to_id, amount });
}
document.getElementById('btnSend').addEventListener('click', handleSend);

/* ---------- L√≥gica para el Editor de Formulario HTML ---------- */
const formEditorModal = new bootstrap.Modal(document.getElementById('formEditorOverlay'));
const formCodeArea = document.getElementById('formCodeArea');
const formContainer = document.getElementById('formContainer');
const initialFormHtml = formContainer.innerHTML;

document.getElementById('openFormEditorBtn').addEventListener('click', () => {
    formCodeArea.value = formContainer.innerHTML.trim();
    formEditorModal.show();
});

document.getElementById('applyHtmlChanges').addEventListener('click', () => {
    formContainer.innerHTML = formCodeArea.value;
    const newSendButton = document.getElementById('btnSend');
    if (newSendButton) { newSendButton.addEventListener('click', handleSend); }
    formEditorModal.hide();
});

/* ---------- Enunciado modal y reinicio ---------- */
document.getElementById('btnReset').addEventListener('click', resetGame);

// Inicializar juego
resetGame();

const modalEnunciado = new bootstrap.Modal(document.getElementById('modalEnunciado'));
document.getElementById('btnEnunciado').addEventListener('click', ()=> { modalEnunciado.show(); });

const flagModal = new bootstrap.Modal(document.getElementById('flagModal')); // Initialize the new flag modal

document.getElementById('copyFlagBtn').addEventListener('click', () => {
  const flagText = document.getElementById('flag').textContent;
  navigator.clipboard.writeText(flagText).then(() => {
    const copyBtn = document.getElementById('copyFlagBtn');
    copyBtn.textContent = '¬°Flag copiada!';
    setTimeout(() => {
      copyBtn.textContent = 'Copiar Flag';
    }, 2000);
  }).catch(err => {
    console.error('Error al copiar el flag: ', err);
    alert('Error al copiar el flag. Por favor, c√≥pialo manualmente.');
  });
});
</script>
</body>
</html>
