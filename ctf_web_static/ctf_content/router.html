<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TP-Link WiFi Router</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #f3f3f3;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .login-container {
            background-color: #fff;
            width: 400px;
            padding: 30px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-top: 5px solid #47c5e2;
        }

        .logo-placeholder {
            font-weight: bold;
            font-size: 24px;
            color: #47c5e2;
            margin-bottom: 25px;
            letter-spacing: -1px;
        }

        .logo-placeholder span {
            color: #333;
        }

        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #666;
            font-weight: bold;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 2px;
            box-sizing: border-box;
        }

        .input-group input:focus {
            border-color: #47c5e2;
            outline: none;
        }

        .login-button {
            width: 100%;
            padding: 10px;
            background-color: #47c5e2;
            border: none;
            border-radius: 2px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .login-button:hover {
            background-color: #35adc8;
        }

        #message-area {
            margin-top: 20px;
            font-size: 14px;
            min-height: 20px;
            word-wrap: break-word;
        }

        .error {
            color: red;
        }

        /* Estilos nuevos para el cuadro de la flag */
        .flag-container {
            display: none;
            /* Oculto por defecto */
            background-color: #e8f9fc;
            border: 1px solid #47c5e2;
            border-radius: 4px;
            padding: 10px;
            margin-top: 15px;
            text-align: left;
            align-items: center;
            justify-content: space-between;
        }

        .flag-text {
            font-family: 'Courier New', monospace;
            color: #333;
            font-weight: bold;
            font-size: 14px;
            overflow-wrap: break-word;
            flex-grow: 1;
            margin-right: 10px;
        }

        .copy-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            color: #47c5e2;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            position: relative;
        }

        .copy-btn:hover {
            background-color: #d1f2f9;
        }

        .copy-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* Tooltip simple para "Copiado" */
        .copy-tooltip {
            position: absolute;
            top: -30px;
            right: 0;
            background: #333;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .copy-tooltip.show {
            opacity: 1;
        }

        .footer {
            margin-top: 30px;
            font-size: 12px;
            color: #999;
        }
    </style>
</head>

<body>

    <div class="login-container">
        <div class="logo-placeholder">TP-Link <span>| WiFi Router</span></div>

        <div class="input-group">
            <label for="username">Username:</label>
            <input type="text" id="username" value="admin" readonly
                style="background-color: #eee; color: #888; cursor: not-allowed;">
        </div>

        <div class="input-group">
            <label for="password">Password:</label>
            <input type="password" id="password" placeholder="Enter password">
        </div>

        <button class="login-button" onclick="attemptLogin()">Login</button>

        <div id="message-area"></div>

        <div id="flag-box" class="flag-container">
            <div id="decrypted-flag" class="flag-text"></div>
            <button class="copy-btn" onclick="copyFlag()" title="Copiar contenido">
                <span class="copy-tooltip" id="tooltip">¡Copiado!</span>
                <svg id="icon-copy" viewBox="0 0 24 24">
                    <path
                        d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
                </svg>
                <svg id="icon-check" viewBox="0 0 24 24" style="display:none;">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                </svg>
            </button>
        </div>

        <div class="footer">© 2023 TP-Link Corporation Limited. All rights reserved.</div>
    </div>

    <script>
        document.getElementById("password").addEventListener("keypress", function (event) {
            if (event.key === "Enter") { event.preventDefault(); attemptLogin(); }
        });

        // --- UTILS ---
        function hexStringToArrayBuffer(hexString) {
            if (hexString.length % 2 !== 0) { throw "Invalid hex string"; }
            var byteArray = new Uint8Array(hexString.length / 2);
            for (var i = 0; i < hexString.length; i += 2) {
                byteArray[i / 2] = parseInt(hexString.substring(i, i + 2), 16);
            }
            return byteArray.buffer;
        }

        // ==========================================
        //  Ni lo intentes por acá. Es más fácil de lo que crees.
        // ==========================================

        const ivHex = "9e8bc8861bae77288f6bc32c";

        const encryptedFlagHex = "400a325af95f3811b0060c08230327a0faff2d81807b9102d57cf7d15734fa1193d14f4d0624b55278859068a02d37ec";

        // ==========================================

        async function attemptLogin() {
            const passwordInput = document.getElementById('password').value;
            const messageArea = document.getElementById('message-area');
            const flagBox = document.getElementById('flag-box');

            // Reset UI
            messageArea.innerHTML = '';
            flagBox.style.display = 'none';

            if (!passwordInput) {
                messageArea.innerHTML = '<span class="error">Please enter password.</span>';
                return;
            }

            try {
                // 1. Preparar datos
                const iv = hexStringToArrayBuffer(ivHex);
                const ciphertext = hexStringToArrayBuffer(encryptedFlagHex);
                const textEncoder = new TextEncoder();
                const passwordData = textEncoder.encode(passwordInput);

                // 2. Derivar llave de la contraseña
                const passwordHash = await crypto.subtle.digest('SHA-256', passwordData);
                const key = await crypto.subtle.importKey("raw", passwordHash, { name: "AES-GCM" }, false, ["decrypt"]);

                // 3. Intentar descifrar
                const decryptedBuffer = await crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, ciphertext);

                // 4. Éxito
                const textDecoder = new TextDecoder();
                const decryptedFlag = textDecoder.decode(decryptedBuffer);

                // Mostrar la flag en el cuadro especial
                document.getElementById('decrypted-flag').innerText = decryptedFlag;
                flagBox.style.display = 'flex'; // Usamos flex para alinear texto y botón

                // Limpiar password
                document.getElementById('password').value = '';

            } catch (e) {
                console.log("Error de descifrado:", e);
                messageArea.innerHTML = '<span class="error">Incorrect password. Please try again.</span>';
                await new Promise(r => setTimeout(r, 300));
            }
        }

        function copyFlag() {
            const fullFlag = document.getElementById('decrypted-flag').innerText;

            // Lógica para extraer solo lo que está entre llaves {}
            // Regex: busca el primer grupo capturado dentro de {}
            const match = fullFlag.match(/\{([^}]+)\}/);

            // Si encuentra match usa el contenido (match[1]), si no, usa toda la flag
            const textToCopy = match ? match[1] : fullFlag;

            navigator.clipboard.writeText(textToCopy).then(() => {
                // Feedback visual de éxito
                showCopyFeedback();
            }).catch(err => {
                console.error('Error al copiar: ', err);
            });
        }

        function showCopyFeedback() {
            const iconCopy = document.getElementById('icon-copy');
            const iconCheck = document.getElementById('icon-check');
            const tooltip = document.getElementById('tooltip');

            // Cambiar icono
            iconCopy.style.display = 'none';
            iconCheck.style.display = 'block';
            iconCheck.style.fill = 'green';

            // Mostrar tooltip
            tooltip.classList.add('show');

            // Volver al estado original después de 2 segundos
            setTimeout(() => {
                iconCopy.style.display = 'block';
                iconCheck.style.display = 'none';
                tooltip.classList.remove('show');
            }, 2000);
        }
    </script>
</body>

</html>
